services:
  n8n:
    build:
      context: .
      pull: true
      dockerfile_inline: |
        # Stage: preparar bash + certs + deps reales
        FROM alpine:3.23 AS deps
        RUN apk add --no-cache bash ca-certificates

        # Empaquetar bash y TODAS sus libs (detectadas con ldd) en /out
        RUN set -eux; \
            mkdir -p /out/bin /out/lib /out/etc/ssl/certs; \
            cp -a /bin/bash /out/bin/; \
            cp -a /etc/ssl/certs/ca-certificates.crt /out/etc/ssl/certs/; \
            # copiar loader + libs que bash necesita (ldd)
            ldd /bin/bash | awk '{print $1,$3}' | \
              awk '$2 ~ /^\// {print $2} $1 ~ /^\// {print $1}' | \
              sort -u | \
              xargs -r -I{} cp -a {} /out/lib/ || true

        FROM python:3.13-alpine AS py

        FROM n8nio/n8n:2.2.0
        USER root

        # bash + libs + certs (sin apk en la imagen final)
        COPY --from=deps /out/ /

        # Python 3.13
        COPY --from=py /usr/local/bin/python3.13 /usr/local/bin/
        COPY --from=py /usr/local/bin/python3 /usr/local/bin/
        COPY --from=py /usr/local/bin/pip3.13 /usr/local/bin/
        COPY --from=py /usr/local/bin/pip3 /usr/local/bin/
        COPY --from=py /usr/local/lib/python3.13 /usr/local/lib/python3.13
        COPY --from=py /usr/local/lib/libpython3.13.so* /usr/local/lib/

        RUN ln -sf /usr/local/bin/python3 /usr/local/bin/python \
          && python3 --version \
          && pip3 --version \
          && pip3 install --no-cache-dir httpx

        USER node

    image: n8n-python:local
    container_name: n8n

    ports:
      - "5678:5678"

    environment:
      TZ: America/Bogota
      GENERIC_TIMEZONE: America/Bogota
      N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: "true"
      SOCKET_HOST: host.docker.internal
      SOCKET_PORT: "7345"
      OLLAMA_HOST: http://host.docker.internal:11434
      NODES_EXCLUDE: "[]"
      # Clave para httpx:
      NO_PROXY: "localhost,127.0.0.1,host.docker.internal"
      no_proxy: "localhost,127.0.0.1,host.docker.internal"
      HTTP_PROXY: ""
      HTTPS_PROXY: ""
      ALL_PROXY: ""
      http_proxy: ""
      https_proxy: ""
      all_proxy: ""

    dns:
      - 1.1.1.1
      - 8.8.8.8
    dns_opt:
      - ndots:1
    
    extra_hosts:
      - "host.docker.internal:host-gateway"

    volumes:
      - n8n_data:/home/node/.n8n
      - ../python:/home/node/python
      - ./projects:/home/node/projects
      - ./context:/data/gamegen/context
      - ../prompt:/prompt
      - ../../../bot/pocketBot:/data/pocket

    restart: unless-stopped

volumes:
  n8n_data: {}

# Cómo levantar todo (único comando)
# docker compose up -d --build
